<!DOCTYPE html>
<html>
    <head>
        <title>Entities example - Boxes</title>
    </head>
    
    <body>
        <canvas id='canvas'></canvas>
        
        <script language="javascript" type="text/javascript" src="../dist/browser-polyfill.min.js"></script>
        <script language="javascript" type="text/javascript" src="../dist/entities.js"></script>
        
        <script>
            var canvas = document.getElementById('canvas');
                canvas.width = 500;
                canvas.height = 500;
            
            var context = canvas.getContext('2d');
            
            var entityManager = new Entities.EntityManager();
            
            var cubes = [];
            
            function init() {
                for (var i = 0; i < cubes.length; ++i) {
                    entityManager.deleteEntity(cubes[i]);
                    numbSpawnedObjects--;
                }
            };
            
            var Menu = {
                isOpen : true,
                
                draw : function() {
                    context.beginPath();
                    context.rect((canvas.width / 2) - 50, (canvas.height / 2) - 20, 100, 40);
                    context.fillStyle = 'lightblue';
                    context.fill();
                    
                    context.font      = '30px Verdana';
                    context.fillStyle = 'black';
                    context.fillText('Start!', (canvas.width / 2) - 40, (canvas.height / 2) + 10);
                },
                startIsClicked : function(x, y) {
                    var buttonX = (canvas.width  / 2) - 50;
                    var buttonY = (canvas.height / 2) - 20;
                    var buttonW = 100;
                    var buttonH = 40;
                    
                    return x >= buttonX && x <= buttonX + buttonW && y >= buttonY && y <= buttonY + buttonH;
                },
                onStartClicked : function() {
                    this.isOpen = false;
                    
                    init();
                }
            };
            
            // Components
            
            var transform = entityManager.registerComponent(function() {
                this.x =      Math.random() * 20;
                this.w = 15 + Math.random() * 5,
                this.h = 15 + Math.random() * 5;
                this.y =      Math.random() * canvas.height - this.h;
            });
            
            var velocity = entityManager.registerComponent(0.05);
            
            var clickable = entityManager.registerComponent({
                isClicked   : false, // todo : use with trigger Delayed to change color before remove
                hitboxRatio : 1.5
            });
            
            var appearance = entityManager.registerComponent({ color : 'red' });
            
            // Systems
            entityManager.registerSystem(function(entities) {
                for (var entity of entities) {
                    var tra = this[transform][entity];
                    var app = this[appearance][entity];
                    
                    context.beginPath();
                    context.rect(tra.x, tra.y, tra.w, tra.h);
                    context.fillStyle = app.color;
                    context.fill();
                }
            }, transform | appearance, Entities.SystemType.Render);
            
            entityManager.registerSystem(function(entities, delta) {
                for (var entity of entities) {
                    var tra = this[transform][entity];
                    var vel = this[velocity][entity];
            
                    tra.x += vel * delta;
                    
                    if (tra.x > canvas.width) {
                        this.trigger('lost');
                    }
                }
            }, transform | velocity);
            
            // Events
            
            var numbSpawnedObjects = 0;
            
            entityManager.listen('clicked', function(entity) {
                entityManager.deleteEntity(entity);
                numbSpawnedObjects--;
            });
            
            entityManager.listen('lost', function(entity) {
                // todo: reset game -> create init function
                Menu.isOpen = true;
            });
            
            entityManager.listen('click', function(x, y) {
                for (var entity of this.getEntities(clickable, transform)) {
                    var tra = this[transform][entity];
                    var cli = this[clickable][entity];
                    
                    var boxW = tra.w * cli.hitboxRatio;
                    var boxH = tra.h * cli.hitboxRatio;
                    var boxX = tra.x - (boxW - tra.w) / 2;
                    var boxY = tra.y - (boxH - tra.h) / 2;
                    
                    if (x >= boxX && x <= boxX + boxW && y >= boxY && y <= boxY + boxH) {
                        this.trigger('clicked', entity);
                    }
                }
            });
            
            // DOM events
            
            canvas.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                var rect = canvas.getBoundingClientRect();
                
                var x = e.clientX - rect.left;
                var y = e.clientY - rect.top;
                
                if (Menu.isOpen) {
                    if (Menu.startIsClicked(x, y)) {
                        Menu.onStartClicked();
                    }
                } else {
                    entityManager.trigger('click', x, y);
                }
            });
            
            var conifguration = entityManager.build()
                                             .withComponent(transform)
                                             .withComponent(velocity, function() { return Math.random() * 0.1 + 0.05; })
                                             .withComponent(clickable)
                                             .withComponent(appearance)
                                             .createConfiguration();
            
            // spawn
            setInterval(function() {
                if (numbSpawnedObjects < 15) {
                    cubes.push(entityManager.create(1, conifguration));
                    numbSpawnedObjects++;
                }
            }, 500);
            
            var delta    = 0;
            var lastTime = new Date();
            var time     = new Date();
            
            function loop() {
                setTimeout(function () {
                    time     = new Date();
                    delta    = time.getTime() - lastTime.getTime();
                    lastTime = time;
                    
                    if (Menu.isOpen) {
                        Menu.draw();
                    } else {
                        entityManager.onLogic(delta);
                        
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        
                        entityManager.onRender(delta);
                    }
                    
                    loop();
                }, 16);
            }
            
            loop();
        </script>
    </body>
</html>