<!DOCTYPE html>
<html>
    <head>
        <title>Entities example - Boxes</title>
    </head>
    
    <body>
        <canvas id='canvas'></canvas>
        
        <script language="javascript" type="text/javascript" src="../dist/browser-polyfill.min.js"></script>
        <script language="javascript" type="text/javascript" src="../dist/entities.js"></script>
        
        <script>
            var canvas = document.getElementById('canvas');
            canvas.width = 500;
            canvas.height = 500;
            var context = canvas.getContext('2d');
            
            var entityManager = new Entities.EntityManager();
            
            var transform = entityManager.registerComponent(function() {
                this.x =      Math.random() * 20;
                this.w = 15 + Math.random() * 5,
                this.h = 15 + Math.random() * 5;
                this.y =      Math.random() * canvas.height - this.h;
            });
            
            var velocity = entityManager.registerComponent(0.05);
            
            entityManager.registerInitializer(velocity, function() { return Math.random() * 0.1 + 0.05; });
            
            var clickable = entityManager.registerComponent({
                isClicked   : false,
                hitboxRatio : 1.5
            });
            
            var appearance = entityManager.registerComponent({ color : 'red' });
            
            entityManager.registerSystem(function(entities) {
                for (var entity of entities) {
                    var tra = this[transform][entity];
                    var app = this[appearance][entity];
                    
                    context.beginPath();
                    context.rect(tra.x, tra.y, tra.w, tra.h);
                    context.fillStyle = app.color;
                    context.fill();
                }
            }, transform | appearance, Entities.SystemType.Render);
            
            entityManager.registerSystem(function(entities, delta) {
                for (var entity of entities) {
                    var tra = this[transform][entity];
                    var vel = this[velocity][entity];
            
                    tra.x += vel * delta;
                    
                    if (tra.x > canvas.width) {
                        this.trigger('lose');
                    }
                }
            }, transform | velocity);
            
            entityManager.listen('click', function(x, y) {
                for (var entity of this.getEntities(clickable, transform)) {
                    var tra = this[transform][entity];
                    var cli = this[clickable][entity];
                    
                    var boxW = tra.w * cli.hitboxRatio;
                    var boxH = tra.h * cli.hitboxRatio;
                    var boxX = tra.x - (boxW - tra.w) / 2;
                    var boxY = tra.y - (boxH - tra.h) / 2;
                    
                    if (x >= boxX && x <= boxX + boxW &&
                        y >= boxY && y <= boxY + boxH) {
                        this.trigger('collision', entity);
                    }
                }
            });
            
            canvas.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                var rect = canvas.getBoundingClientRect();
                
                entityManager.trigger('click', e.clientX - rect.left, e.clientY - rect.top);
            });
            
            var conifguration = entityManager.build()
                                             .withComponent(transform)
                                             .withComponent(velocity)
                                             .withComponent(clickable)
                                             .withComponent(appearance)
                                             .createConfiguration();
            
            var numbSpawnedObjects = 0;
            
            entityManager.listen('collision', function(entity) {
                entityManager.deleteEntity(entity);
                numbSpawnedObjects--;
            });
            
            entityManager.listen('lose', function(entity) {
                alert('lose');
            });
            
            // spawn
            setInterval(function() {
                if (numbSpawnedObjects < 15) {
                    entityManager.create(1, conifguration);
                    numbSpawnedObjects++;
                }
            }, 500);
            
            var delta    = 0;
            var lastTime = new Date();
            var time     = new Date();
            
            function loop() {
                setTimeout(function () {
                    time     = new Date();
                    delta    = time.getTime() - lastTime.getTime();
                    lastTime = time;
                    
                    entityManager.onLogic(delta);
                    
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    
                    entityManager.onRender(delta);
                    
                    loop();
                }, 16);
            }
            
            loop();
        </script>
    </body>
</html>