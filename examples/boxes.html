<!DOCTYPE html>
<html>
    <head>
        <title>Entities example - Boxes</title>
    </head>
    
    <body>
        <canvas id='canvas'></canvas>
        
        <script language="javascript" type="text/javascript" src="polyfill.js"></script>
        <script language="javascript" type="text/javascript" src="../dist/gg-entities.js"></script>
        
        <script>
            window.onload = function() {
                var canvas = document.getElementById('canvas');
                    canvas.width = 500;
                    canvas.height = 500;
                
                var context = canvas.getContext('2d');
                
                var entityManager = new GGEntities.EntityManager();
                
                var cubes = [];
                
                var Menu = {
                    isOpen : true,
                    
                    draw : function() {
                        context.beginPath();
                        context.rect((canvas.width / 2) - 50, (canvas.height / 2) - 20, 100, 40);
                        context.fillStyle = 'lightblue';
                        context.fill();
                        
                        context.font      = '30px Verdana';
                        context.fillStyle = 'black';
                        context.fillText('Start!', (canvas.width / 2) - 40, (canvas.height / 2) + 10);
                    },
                    startIsClicked : function(x, y) {
                        var buttonX = (canvas.width  / 2) - 50;
                        var buttonY = (canvas.height / 2) - 20;
                        var buttonW = 100;
                        var buttonH = 40;
                        
                        return x >= buttonX && x <= buttonX + buttonW && y >= buttonY && y <= buttonY + buttonH;
                    },
                    onStartClicked : function() {
                        this.isOpen = false;
                        
                        entityManager.onInit();
                    }
                };
                
                // Components
                
                var transform = entityManager.registerComponent(function() {
                    this.x =      Math.random() * 20;
                    this.w = 15 + Math.random() * 5,
                    this.h = 15 + Math.random() * 5;
                    this.y =      Math.random() * canvas.height - this.h;
                });
                
                var velocity = entityManager.registerComponent(0.05);
                
                var clickable = entityManager.registerComponent(function() {
                    this.timesClicked = 0,
                    this.maxClicks    = Math.floor(Math.random() * (2 - 1 + 1)) + 1,
                    this.hitboxRatio  = 1.5
                });
                
                var appearance = entityManager.registerComponent({ color : 'red' });
                
                // Systems
                
                var initSystem = function() {
                    for (var i = 0; i < cubes.length; ++i) {
                        this.deleteEntity(cubes[i]);
                        numbSpawnedObjects--;
                    }
                    
                    cubes = [];
                }
                
                entityManager.registerInitSystem(GGEntities.SelectorType.Get, 0, initSystem);
                
                var movementSystem = function(entities, delta) {
                    for (var entity of entities) {
                        var tra = this[transform][entity];
                        var vel = this[velocity][entity];
                
                        tra.x += vel * delta;
                        
                        if (tra.x > canvas.width) {
                            this.trigger('outOfBounds');
                        }
                    }
                };
                
                entityManager.registerLogicSystem(GGEntities.SelectorType.GetWith, transform | velocity, movementSystem);
                
                var renderSystem = function(entities) {
                    for (var entity of entities) {
                        var tra = this[transform][entity];
                        var app = this[appearance][entity];
                        
                        context.beginPath();
                        context.rect(tra.x, tra.y, tra.w, tra.h);
                        context.fillStyle = app.color;
                        context.fill();
                    }
                };
                                             
                entityManager.registerRenderSystem(GGEntities.SelectorType.GetWith, transform | appearance, renderSystem);
                
                // Events
                
                var numbSpawnedObjects = 0;
                
                entityManager.listen('clicked', function(entity) {
                    var cli = this[clickable][entity];
                    
                    cli.timesClicked++;
                    
                    if (cli.timesClicked > cli.maxClicks) {
                        return;
                    }
                    
                    var clicksLeft = cli.maxClicks - cli.timesClicked;
                    
                    switch (clicksLeft) {
                        case 0 : {
                            this[appearance][entity].color = 'purple';
                            this.triggerDelayed('destroy', 400, entity);
                            
                             break;
                        }
                        case 1 : this[appearance][entity].color = 'blue'; break;
                    }
                });
                
                entityManager.listen('destroy', function(entity) {
                    this.deleteEntity(entity);
                    numbSpawnedObjects--;
                });
                
                entityManager.listen('outOfBounds', function(entity) {
                    Menu.isOpen = true;
                });
                
                entityManager.listen('click', function(x, y) {
                    for (var entity of this.getEntities(clickable, transform, appearance)) {
                        var tra = this[transform][entity];
                        var cli = this[clickable][entity];
                        
                        var boxW = tra.w * cli.hitboxRatio;
                        var boxH = tra.h * cli.hitboxRatio;
                        var boxX = tra.x - (boxW - tra.w) / 2;
                        var boxY = tra.y - (boxH - tra.h) / 2;
                        
                        if (x >= boxX && x <= boxX + boxW && y >= boxY && y <= boxY + boxH) {
                            this.trigger('clicked', entity);
                        }
                    }
                });
                
                // DOM events
                
                canvas.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var rect = canvas.getBoundingClientRect();
                    
                    // x and y relative to canvas
                    var x = e.clientX - rect.left;
                    var y = e.clientY - rect.top;
                    
                    if (Menu.isOpen) {
                        if (Menu.startIsClicked(x, y)) {
                            Menu.onStartClicked();
                        }
                    } else {
                        entityManager.trigger('click', x, y);
                    }
                });
                
                // Create a configuration which we can use with entityManager.create() later
                var conifguration = entityManager.build()
                                                 .withComponent(transform)
                                                 // second param is a initializer function
                                                 .withComponent(velocity, function() { return Math.random() * 0.075 + 0.025; })
                                                 .withComponent(clickable)
                                                 .withComponent(appearance)
                                                 .createConfiguration();
                
                // spawn a new object (cube) every .5 secs (if there are less then 15 spawned objects)
                // timed systems (or coroutines) will probably be added to the library sometime post v. 1.0.0
                setInterval(function() {
                    if (numbSpawnedObjects < 15) {
                        cubes.push(entityManager.create(1, conifguration));
                        numbSpawnedObjects++;
                    }
                }, 500);
                
                // For timing
                var delta    = 0;
                var lastTime = new Date();
                var time     = new Date();
                
                // Run main loop
                function loop() {
                    setTimeout(function () {
                        time     = new Date();
                        delta    = time.getTime() - lastTime.getTime();
                        lastTime = time;
                        
                        if (Menu.isOpen) {
                            Menu.draw();
                        } else {
                            entityManager.onLogic(delta);
                            
                            context.clearRect(0, 0, canvas.width, canvas.height);
                            
                            entityManager.onRender(delta);
                        }
                        
                        loop();
                    }, 16);
                }
                
                loop();
            };
        </script>
    </body>
</html>