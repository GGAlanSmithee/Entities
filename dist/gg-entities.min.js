!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("GGEntities",["exports"],e):e(t.GGEntities=t.GGEntities||{})}(this,function(t){"use strict";var e={};e["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},e.classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e.createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),e.slicedToArray=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(u){i=!0,o=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),e.toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)};var n=function(){function t(){e.classCallCheck(this,t),this.initializers=new Map,this.configuration=new Map}return e.createClass(t,[{key:"registerInitializer",value:function(t,e){if("string"!=typeof t||""===t)throw TypeError("key must be a non-empty string.");if("function"!=typeof e)throw TypeError("initializer must be a function.");this.initializers.set(t,e)}},{key:"build",value:function(){return this.configuration=new Map,this}},{key:"withComponent",value:function(t,e){return"string"!=typeof t||""===t?this:("function"!=typeof e&&(e=this.initializers.get(t)),this.configuration.set(t,e),this)}},{key:"createConfiguration",value:function(){return this.configuration}},{key:"create",value:function(t){var n=arguments.length<=1||void 0===arguments[1]?1:arguments[1],r=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];if(!(t instanceof s))return[];r=r||this.configuration;var i=[],o=!0,a=!1,u=void 0;try{for(var c,y=r.keys()[Symbol.iterator]();!(o=(c=y.next()).done);o=!0){var l=c.value;i.push(l)}}catch(f){a=!0,u=f}finally{try{!o&&y["return"]&&y["return"]()}finally{if(a)throw u}}for(var h=[],v=0;n>v;++v){var p=t.newEntity(i),m=p.id,d=p.entity;if(m>=t.capacity)break;var g=!0,k=!1,b=void 0;try{for(var w,C=r[Symbol.iterator]();!(g=(w=C.next()).done);g=!0){var S=e.slicedToArray(w.value,2),l=S[0],M=S[1];if("function"==typeof M){var E=M.call(d[l]);"object"!==e["typeof"](d[l])&&void 0!==E&&(d[l]=E)}}}catch(f){k=!0,b=f}finally{try{!g&&C["return"]&&C["return"]()}finally{if(k)throw b}}h.push({id:m,entity:d})}return 1===h.length?h[0]:h}}]),t}(),r=function(){function t(){e.classCallCheck(this,t),this.components=new Map}return e.createClass(t,[{key:"newComponent",value:function(t){var n=this.components.get(t);if(null==n)return null;switch("undefined"==typeof n?"undefined":e["typeof"](n)){case"function":return new n;case"object":return function(t){var e={};return Object.keys(t).forEach(function(n){return e[n]=t[n]}),e}(n);default:return n}}},{key:"registerComponent",value:function(t,e){if("string"!=typeof t||""===t)throw TypeError("key must be a non-empty string.");if(null===e||void 0===e)throw TypeError("component cannot be null or undefined.");return this.components.set(t,e),t}},{key:"getComponents",value:function(){return this.components}}]),t}(),i={Logic:0,Render:1,Init:2},o=function(){function t(){e.classCallCheck(this,t),this.logicSystems=new Map,this.renderSystems=new Map,this.initSystems=new Map}return e.createClass(t,[{key:"registerSystem",value:function(t,e,n,r){if("string"!=typeof t||""===t)throw TypeError("key must be a non-empty string.");if(e!==i.Logic&&e!==i.Render&&e!==i.Init)throw TypeError("type must be a valid SystemType.");if(!Array.isArray(n))throw TypeError("components argument must be an array of components.");if("function"!=typeof r)throw TypeError("callback must be a function.");var o={components:n,callback:r};switch(e){case i.Logic:this.logicSystems.set(t,o);break;case i.Render:this.renderSystems.set(t,o);break;case i.Init:this.initSystems.set(t,o)}return t}},{key:"removeSystem",value:function(t){return this.logicSystems["delete"](t)||this.renderSystems["delete"](t)||this.initSystems["delete"](t)}}]),t}(),a=function(){function t(){e.classCallCheck(this,t),this.events=new Map}return e.createClass(t,[{key:"emptyPromise",value:function(){return new Promise(function(t){t()})}},{key:"promise",value:function(t,n,r,i){return i?new Promise(function(o){setTimeout(function(){o("object"===("undefined"==typeof n?"undefined":e["typeof"](n))?t.call.apply(t,[n].concat(e.toConsumableArray(r))):t.apply.apply(t,[n].concat(e.toConsumableArray(r))))},i)}):new Promise(function(i){i("object"===("undefined"==typeof n?"undefined":e["typeof"](n))?t.call.apply(t,[n].concat(e.toConsumableArray(r))):t.apply.apply(t,[n].concat(e.toConsumableArray(r))))})}},{key:"listen",value:function(t,n){if("string"==typeof t&&"function"==typeof n){this.events.has(t)||this.events.set(t,new Map);var r=-1;return this.events.forEach(function(t){r=Math.max.apply(Math,[r].concat(e.toConsumableArray(t.keys())))}),++r,this.events.get(t).set(r,n),r}}},{key:"stopListen",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,o=this.events.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var a=i.value,s=!0,u=!1,c=void 0;try{for(var y,l=a.keys()[Symbol.iterator]();!(s=(y=l.next()).done);s=!0){var f=y.value;if(f===t)return a["delete"](t)}}catch(h){u=!0,c=h}finally{try{!s&&l["return"]&&l["return"]()}finally{if(u)throw c}}}}catch(h){n=!0,r=h}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw r}}return!1}},{key:"trigger",value:function(){var t=this instanceof s?this.eventHandler:this,n=Array.from(arguments),r=n.splice(0,1),i=e.slicedToArray(r,1),o=i[0];if("string"!=typeof o||!t.events.has(o))return t.emptyPromise();var a=[],u=!0,c=!1,y=void 0;try{for(var l,f=t.events.get(o).values()[Symbol.iterator]();!(u=(l=f.next()).done);u=!0){var h=l.value;a.push(t.promise(h,this,n,1))}}catch(v){c=!0,y=v}finally{try{!u&&f["return"]&&f["return"]()}finally{if(c)throw y}}return Promise.all(a)}},{key:"triggerDelayed",value:function(){var t=this instanceof s?this.eventHandler:this,n=Array.from(arguments),r=n.splice(0,2),i=e.slicedToArray(r,2),o=i[0],a=i[1];if("string"!=typeof o||!Number.isInteger(a)||!t.events.has(o))return t.emptyPromise();var u=[],c=!0,y=!1,l=void 0;try{for(var f,h=t.events.get(o).values()[Symbol.iterator]();!(c=(f=h.next()).done);c=!0){var v=f.value;u.push(t.promise(v,this,n,a))}}catch(p){y=!0,l=p}finally{try{!c&&h["return"]&&h["return"]()}finally{if(y)throw l}}return Promise.all(u)}}]),t}(),s=function(){function t(){var i=arguments.length<=0||void 0===arguments[0]?1e3:arguments[0];e.classCallCheck(this,t),this.capacity=i,this.currentMaxEntity=-1,this.entityFactory=new n,this.systemManager=new o,this.componentManager=new r,this.eventHandler=new a,this.entities=Array.from({length:this.capacity},function(){return{components:[]}}),this.entityConfigurations=new Map}return e.createClass(t,[{key:"increaseCapacity",value:function(){var t=this.capacity;this.capacity*=2,this.entities=[].concat(e.toConsumableArray(this.entities),e.toConsumableArray(Array.from({length:t},function(){return{components:[]}})));for(var n=t;n<this.capacity;++n){var r=!0,i=!1,o=void 0;try{for(var a,s=this.componentManager.getComponents().keys()[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value;this.entities[n][u]=this.componentManager.newComponent(u)}}catch(c){i=!0,o=c}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw o}}}}},{key:"newEntity",value:function(t){if(!Array.isArray(t))throw TypeError("components argument must be an array of components.");for(var e=0;e<this.capacity&&0!==this.entities[e].components.length;++e);return e>=this.capacity?{id:this.capacity,entity:null}:(e>this.currentMaxEntity&&(this.currentMaxEntity=e),this.entities[e].components=t,{id:e,entity:this.entities[e]})}},{key:"deleteEntity",value:function(t){if(this.entities[t].components=[],!(t<this.currentMaxEntity)){for(var e=t;e>=0;--e)if(0!==this.entities[e].components.length)return void(this.currentMaxEntity=e);this.currentMaxEntity=0}}},{key:"getEntities",value:regeneratorRuntime.mark(function s(){var t,e,n=this,r=arguments.length<=0||void 0===arguments[0]?null:arguments[0];return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:t=regeneratorRuntime.mark(function o(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==r&&!r.every(function(e){return-1!==n.entities[t].components.indexOf(e)})){e.next=3;break}return e.next=3,{id:t,entity:n.entities[t]};case 3:case"end":return e.stop()}},o,n)}),e=0;case 2:if(!(e<=this.currentMaxEntity)){i.next=7;break}return i.delegateYield(t(e),"t0",4);case 4:++e,i.next=2;break;case 7:case"end":return i.stop()}},s,this)})},{key:"registerConfiguration",value:function(t){if("string"!=typeof t||""===t)throw TypeError("key must be a non empty string.");return this.entityConfigurations.set(t,this.entityFactory.createConfiguration()),t}},{key:"registerComponent",value:function(t,n){this.componentManager.registerComponent(t,n);var r=!0,i=!1,o=void 0;try{for(var a,s=this.entities[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value;u[t]=this.componentManager.newComponent(t)}}catch(c){i=!0,o=c}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw o}}var y=void 0;switch("undefined"==typeof n?"undefined":e["typeof"](n)){case"function":y=n;break;case"object":y=function(){var t=!0,e=!1,r=void 0;try{for(var i,o=Object.keys(n)[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var a=i.value;this[a]=n[a]}}catch(s){e=!0,r=s}finally{try{!t&&o["return"]&&o["return"]()}finally{if(e)throw r}}};break;default:y=function(){return n}}return this.entityFactory.registerInitializer(t,y),t}},{key:"addComponent",value:function(t,e){-1===this.entities[t].components.indexOf(e)&&this.entities[t].components.push(e)}},{key:"removeComponent",value:function(t,e){var n=this.entities[t].components.indexOf(e);-1!==n&&this.entities[t].components.splice(n,1)}},{key:"registerSystem",value:function(t,e,n,r){return this.systemManager.registerSystem(t,e,n,r)}},{key:"registerLogicSystem",value:function(t,e,n){return this.systemManager.registerSystem(t,i.Logic,e,n)}},{key:"registerRenderSystem",value:function(t,e,n){return this.systemManager.registerSystem(t,i.Render,e,n)}},{key:"registerInitSystem",value:function(t,e,n){return this.systemManager.registerSystem(t,i.Init,e,n)}},{key:"removeSystem",value:function(t){return this.systemManager.removeSystem(t)}},{key:"onLogic",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,o=this.systemManager.logicSystems.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var a=i.value;a.callback.call(this,this.getEntities(a.components),t)}}catch(s){n=!0,r=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw r}}}},{key:"onRender",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,o=this.systemManager.renderSystems.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var a=i.value;a.callback.call(this,this.getEntities(a.components),t)}}catch(s){n=!0,r=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw r}}}},{key:"onInit",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,o=this.systemManager.initSystems.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var a=i.value;a.callback.call(this,this.getEntities(a.components),t)}}catch(s){n=!0,r=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(n)throw r}}}},{key:"registerInitializer",value:function(t,e){this.entityFactory.registerInitializer(t,e)}},{key:"build",value:function(){return this.entityFactory.build(),this}},{key:"withComponent",value:function(t,e){return this.entityFactory.withComponent(t,e),this}},{key:"create",value:function(t,e){var n=void 0;if("string"==typeof e&&(n=this.entityConfigurations.get(e),void 0===n))throw TypeError("could not find entity configuration for the supplied key. if you wish to create an entity without a configuration, do not pass a key.");return this.entityFactory.create(this,t,n)}},{key:"listen",value:function(t,e){return this.eventHandler.listen(t,e)}},{key:"stopListen",value:function(t){return this.eventHandler.stopListen(t)}},{key:"trigger",value:function(){var t;return(t=this.eventHandler.trigger).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))}},{key:"triggerDelayed",value:function(){var t;return(t=this.eventHandler.triggerDelayed).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))}}]),t}();t["default"]=s,t.EntityManager=s,t.EntityFactory=n,t.SystemManager=o,t.SystemType=i,t.ComponentManager=r,t.EventHandler=a});