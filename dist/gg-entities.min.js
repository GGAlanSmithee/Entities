!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("GGEntities",["exports"],t):t(e.GGEntities=e.GGEntities||{})}(this,function(e){"use strict";var t={};t["typeof"]="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),t.slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(u){i=!0,a=u}finally{try{!n&&s["return"]&&s["return"]()}finally{if(i)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),t.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)};var r=function(){function e(){t.classCallCheck(this,e),this.components=new Map}return t.createClass(e,[{key:"newComponent",value:function(e){var r=this.components.get(e);if(null===r||void 0===r)return null;switch("undefined"==typeof r?"undefined":t["typeof"](r)){case"function":return new r;case"object":return function(e){var t={};return Object.keys(e).forEach(function(r){return t[r]=e[r]}),t}(r)}return r}},{key:"registerComponent",value:function(e){if(null===e||void 0===e)throw TypeError("component cannot be null.");var r=Math.max.apply(Math,t.toConsumableArray(this.components.keys())),n=void 0===r||null===r||r===-(1/0)?1:0===r?1:2*r;return this.components.set(n,e),n}},{key:"getComponents",value:function(){return this.components}}]),e}(),n={Logic:0,Render:1},i=function(){function r(){t.classCallCheck(this,r),this.logicSystems=new Map,this.renderSystems=new Map}return t.createClass(r,[{key:"registerSystem",value:function(r,i,a,o){if(r!==n.Logic&&r!==n.Render)throw TypeError("type must be a valid SystemType.");if(i!==e.SelectorType.Get&&i!==e.SelectorType.GetWith&&i!==e.SelectorType.GetWithOnly&&i!==e.SelectorType.GetWithout)throw TypeError("selector must be a valid SelectorType.");if("number"!=typeof a)throw TypeError("components must be a number.");if("function"!=typeof o)throw TypeError("callback must be a function.");var s={selector:i,components:a,callback:o},u=Math.max.apply(Math,[0].concat(t.toConsumableArray(this.logicSystems.keys()),t.toConsumableArray(this.renderSystems.keys())))+1;switch(r){case n.Logic:this.logicSystems.set(u,s);break;case n.Render:this.renderSystems.set(u,s)}return u}},{key:"removeSystem",value:function(e){return this.logicSystems["delete"](e)||this.renderSystems["delete"](e)}}]),r}(),a=function(){function e(){t.classCallCheck(this,e),this.events=new Map}return t.createClass(e,[{key:"emptyPromise",value:function(){return new Promise(function(e){e()})}},{key:"promise",value:function(e,r,n,i){return i?new Promise(function(a){setTimeout(function(){a("object"===("undefined"==typeof r?"undefined":t["typeof"](r))?e.call.apply(e,[r].concat(t.toConsumableArray(n))):e.apply.apply(e,[r].concat(t.toConsumableArray(n))))},i)}):new Promise(function(i){i("object"===("undefined"==typeof r?"undefined":t["typeof"](r))?e.call.apply(e,[r].concat(t.toConsumableArray(n))):e.apply.apply(e,[r].concat(t.toConsumableArray(n))))})}},{key:"listen",value:function(e,r){if("string"==typeof e&&"function"==typeof r){this.events.has(e)||this.events.set(e,new Map);var n=-1;return this.events.forEach(function(e){n=Math.max.apply(Math,[n].concat(t.toConsumableArray(e.keys())))}),++n,this.events.get(e).set(n,r),n}}},{key:"stopListen",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this.events.values()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,s=!0,u=!1,c=void 0;try{for(var l,y=o.keys()[Symbol.iterator]();!(s=(l=y.next()).done);s=!0){var f=l.value;if(f===e)return o["delete"](e)}}catch(h){u=!0,c=h}finally{try{!s&&y["return"]&&y["return"]()}finally{if(u)throw c}}}}catch(h){r=!0,n=h}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}return!1}},{key:"trigger",value:function(){var e=this instanceof o?this.eventHandler:this,r=Array.from(arguments),n=r.splice(0,1),i=t.slicedToArray(n,1),a=i[0];if("string"!=typeof a||!e.events.has(a))return e.emptyPromise();var s=[],u=!0,c=!1,l=void 0;try{for(var y,f=e.events.get(a).values()[Symbol.iterator]();!(u=(y=f.next()).done);u=!0){var h=y.value;s.push(e.promise(h,this,r,1))}}catch(v){c=!0,l=v}finally{try{!u&&f["return"]&&f["return"]()}finally{if(c)throw l}}return Promise.all(s)}},{key:"triggerDelayed",value:function(){var e=this instanceof o?this.eventHandler:this,r=Array.from(arguments),n=r.splice(0,2),i=t.slicedToArray(n,2),a=i[0],s=i[1];if("string"!=typeof a||!Number.isInteger(s)||!e.events.has(a))return e.emptyPromise();var u=[],c=!0,l=!1,y=void 0;try{for(var f,h=e.events.get(a).values()[Symbol.iterator]();!(c=(f=h.next()).done);c=!0){var v=f.value;u.push(e.promise(v,this,r,s))}}catch(p){l=!0,y=p}finally{try{!c&&h["return"]&&h["return"]()}finally{if(l)throw y}}return Promise.all(u)}}]),e}();e.SelectorType={Get:0,GetWith:1,GetWithOnly:2,GetWithout:3};var o=function(){function o(){var e=arguments.length<=0||void 0===arguments[0]?1e3:arguments[0];t.classCallCheck(this,o),this.capacity=e,this.currentMaxEntity=-1,this.entityFactory=new s,this.systemManager=new i,this.componentManager=new r,this.eventHandler=new a,this.entities=Array.from({length:this.capacity},function(){return 0})}return t.createClass(o,[{key:"increaseCapacity",value:function(){var e=this.capacity;this.capacity*=2;for(var t=e;t<this.capacity;++t)this.entities[t]=0;var r=!0,n=!1,i=void 0;try{for(var a,o=this.componentManager.getComponents().keys()[Symbol.iterator]();!(r=(a=o.next()).done);r=!0)for(var s=a.value,u=e;u<this.capacity;++u)this[s].push(this.componentManager.newComponent(s))}catch(c){n=!0,i=c}finally{try{!r&&o["return"]&&o["return"]()}finally{if(n)throw i}}}},{key:"newEntity",value:function(e){if("number"!=typeof e||0>=e)return this.capacity;for(var t=0;t<this.capacity&&0!==this.entities[t];++t);return t>=this.capacity?this.capacity:(t>this.currentMaxEntity&&(this.currentMaxEntity=t),this.entities[t]=e,t)}},{key:"deleteEntity",value:function(e){if(this.entities[e]=0,!(e<this.currentMaxEntity))for(var t=e;t>=0;--t)if(0!==this.entities[t])return void(this.currentMaxEntity=t)}},{key:"getEntities",value:regeneratorRuntime.mark(function u(t,r){var n,i,a,o;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:t=t||0,void 0!==r&&null!==r||(r=e.SelectorType.GetWith),s.t0=r,s.next=s.t0===e.SelectorType.GetWith?5:s.t0===e.SelectorType.GetWithOnly?16:s.t0===e.SelectorType.GetWithout?27:s.t0===e.SelectorType.Get?38:48;break;case 5:s.t1=regeneratorRuntime.keys(this.entities);case 6:if((s.t2=s.t1()).done){s.next=15;break}if(n=s.t2.value,!(n>this.currentMaxEntity)){s.next=10;break}return s.abrupt("return");case 10:if(0===this.entities[n]||(this.entities[n]&t)!==t){s.next=13;break}return s.next=13,Math.floor(n);case 13:s.next=6;break;case 15:return s.abrupt("break",48);case 16:s.t3=regeneratorRuntime.keys(this.entities);case 17:if((s.t4=s.t3()).done){s.next=26;break}if(i=s.t4.value,!(i>this.currentMaxEntity)){s.next=21;break}return s.abrupt("return");case 21:if(0===this.entities[i]||this.entities[i]!==t){s.next=24;break}return s.next=24,Math.floor(i);case 24:s.next=17;break;case 26:return s.abrupt("break",48);case 27:s.t5=regeneratorRuntime.keys(this.entities);case 28:if((s.t6=s.t5()).done){s.next=37;break}if(a=s.t6.value,!(a>this.currentMaxEntity)){s.next=32;break}return s.abrupt("return");case 32:if(0===this.entities[a]||(this.entities[a]&t)===t){s.next=35;break}return s.next=35,Math.floor(a);case 35:s.next=28;break;case 37:return s.abrupt("break",48);case 38:s.t7=regeneratorRuntime.keys(this.entities);case 39:if((s.t8=s.t7()).done){s.next=47;break}if(o=s.t8.value,!(o>this.currentMaxEntity)){s.next=43;break}return s.abrupt("return");case 43:return s.next=45,Math.floor(o);case 45:s.next=39;break;case 47:return s.abrupt("break",48);case 48:case"end":return s.stop()}},u,this)})},{key:"registerComponent",value:function(e){var r=this.componentManager.registerComponent(e);this[r]=[];for(var n=0;n<this.capacity;++n)this[r].push(this.componentManager.newComponent(r));var i=void 0;switch("undefined"==typeof e?"undefined":t["typeof"](e)){case"function":i=e;break;case"object":i=function(){var t=!0,r=!1,n=void 0;try{for(var i,a=Object.keys(e)[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;this[o]=e[o]}}catch(s){r=!0,n=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}};break;default:i=function(){return e}}return this.entityFactory.registerInitializer(r,i),r}},{key:"addComponent",value:function(e,t){this.entities[e]|=t}},{key:"removeComponent",value:function(e,t){this.entities[e]&=~t}},{key:"registerSystem",value:function(e,t,r,n){return this.systemManager.registerSystem(e,t,r,n)}},{key:"registerLogicSystem",value:function(e,t,r){return this.systemManager.registerSystem(n.Logic,e,t,r)}},{key:"registerRenderSystem",value:function(e,t,r){return this.systemManager.registerSystem(n.Render,e,t,r)}},{key:"removeSystem",value:function(e){return this.systemManager.removeSystem(e)}},{key:"onLogic",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this.systemManager.logicSystems.values()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;o.callback.call(this,this.getEntities(o.components,o.selector),e)}}catch(s){r=!0,n=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}}},{key:"onRender",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this.systemManager.renderSystems.values()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;o.callback.call(this,this.getEntities(o.components,o.selector),e)}}catch(s){r=!0,n=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(r)throw n}}}},{key:"registerInitializer",value:function(e,t){this.entityFactory.registerInitializer(e,t)}},{key:"build",value:function(){return this.entityFactory.build(),this}},{key:"withComponent",value:function(e,t){return this.entityFactory.withComponent(e,t),this}},{key:"createConfiguration",value:function(){return this.entityFactory.createConfiguration()}},{key:"create",value:function(e,t){return this.entityFactory.create(this,e,t)}},{key:"listen",value:function(e,t){return this.eventHandler.listen(e,t)}},{key:"stopListen",value:function(e){return this.eventHandler.stopListen(e)}},{key:"trigger",value:function(){var e;return(e=this.eventHandler.trigger).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))}},{key:"triggerDelayed",value:function(){var e;return(e=this.eventHandler.triggerDelayed).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))}}]),o}(),s=function(){function e(){t.classCallCheck(this,e),this.initializers=new Map,this.configuration=new Map}return t.createClass(e,[{key:"registerInitializer",value:function(e,t){Number.isInteger(e)&&"function"==typeof t&&this.initializers.set(e,t)}},{key:"build",value:function(){return this.configuration=new Map,this}},{key:"withComponent",value:function(e,t){return Number.isInteger(e)?("function"!=typeof t&&(t=this.initializers.get(e)),this.configuration.set(e,t),this):this}},{key:"createConfiguration",value:function(){return this.configuration}},{key:"create",value:function(e){var r=arguments.length<=1||void 0===arguments[1]?1:arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];if(!(e instanceof o))return[];n=n||this.configuration;var i=0,a=!0,s=!1,u=void 0;try{for(var c,l=n.keys()[Symbol.iterator]();!(a=(c=l.next()).done);a=!0){var y=c.value;i|=y}}catch(f){s=!0,u=f}finally{try{!a&&l["return"]&&l["return"]()}finally{if(s)throw u}}for(var h=[],v=0;r>v;++v){var p=e.newEntity(i);if(!(p>=e.capacity)){var m=!0,d=!1,g=void 0;try{for(var b,k=n[Symbol.iterator]();!(m=(b=k.next()).done);m=!0){var S=t.slicedToArray(b.value,2),w=S[0],x=S[1];if("function"==typeof x){var C=x.call(e[w][p]);"function"!=typeof e[w][p]&&"object"!==t["typeof"](e[w][p])&&void 0!==C&&(e[w][p]=C)}}}catch(f){d=!0,g=f}finally{try{!m&&k["return"]&&k["return"]()}finally{if(d)throw g}}h.push(p)}}return 1===h.length?h[0]:h}}]),e}(),u={EntityManager:o,SelectorType:e.SelectorType,SystemManager:i,SystemType:n,ComponentManager:r,EventHandler:a};e["default"]=u,e.EntityManager=o,e.SystemManager=i,e.SystemType=n,e.ComponentManager=r,e.EventHandler=a});