!function(t,e){if("function"==typeof define&&define.amd)define("GGEntities",["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var n={exports:{}};e(n.exports),t.GGEntities=n.exports}}(this,function(t){"use strict";function e(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=Array.prototype.slice,i=function(){function t(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(u){i=!0,a=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o={Logic:0,Render:1},s=function(){function t(){n(this,t),this.logicSystems=new Map,this.renderSystems=new Map}return a(t,[{key:"registerSystem",value:function(t,n,r,i){if(t!==o.Logic&&t!==o.Render)throw TypeError("type must be a valid SystemType.");if(n!==l.Get&&n!==l.GetWith&&n!==l.GetWithOnly&&n!==l.GetWithout)throw TypeError("selector must be a valid SelectorType.");if("number"!=typeof r)throw TypeError("components must be a number.");if("function"!=typeof i)throw TypeError("callback must be a function.");var a={selector:n,components:r,callback:i},s=Math.max.apply(Math,[0].concat(e(this.logicSystems.keys()),e(this.renderSystems.keys())))+1;switch(t){case o.Logic:this.logicSystems.set(s,a);break;case o.Render:this.renderSystems.set(s,a)}return s}},{key:"removeSystem",value:function(t){return this.logicSystems["delete"](t)||this.renderSystems["delete"](t)}}]),t}(),u=function(){function t(){n(this,t),this.events=new Map}return a(t,[{key:"emptyPromise",value:function(){return new Promise(function(t){t()})}},{key:"promise",value:function(t,n,r,i){return i?new Promise(function(a){setTimeout(function(){a("object"==typeof n?t.call.apply(t,[n].concat(e(r))):t.apply.apply(t,[n].concat(e(r))))},i)}):new Promise(function(i){i("object"==typeof n?t.call.apply(t,[n].concat(e(r))):t.apply.apply(t,[n].concat(e(r))))})}},{key:"listen",value:function(t,n){if("string"==typeof t&&"function"==typeof n){this.events.has(t)||this.events.set(t,new Map);var r=-1;return this.events.forEach(function(t){r=Math.max.apply(Math,[r].concat(e(t.keys())))}),++r,this.events.get(t).set(r,n),r}}},{key:"stopListen",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=this.events.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value,s=!0,u=!1,c=void 0;try{for(var l,y=o.keys()[Symbol.iterator]();!(s=(l=y.next()).done);s=!0){var f=l.value;if(f===t)return o["delete"](t)}}catch(h){u=!0,c=h}finally{try{!s&&y["return"]&&y["return"]()}finally{if(u)throw c}}}}catch(h){n=!0,r=h}finally{try{!e&&a["return"]&&a["return"]()}finally{if(n)throw r}}return!1}},{key:"trigger",value:function(){var t=this instanceof y?this.eventHandler:this,e=Array.from(arguments),n=e.splice(0,1),r=i(n,1),a=r[0];if("string"!=typeof a||!t.events.has(a))return t.emptyPromise();var o=[],s=!0,u=!1,c=void 0;try{for(var l,f=t.events.get(a).values()[Symbol.iterator]();!(s=(l=f.next()).done);s=!0){var h=l.value;o.push(t.promise(h,this,e,1))}}catch(v){u=!0,c=v}finally{try{!s&&f["return"]&&f["return"]()}finally{if(u)throw c}}return Promise.all(o)}},{key:"triggerDelayed",value:function(){var t=this instanceof y?this.eventHandler:this,e=Array.from(arguments),n=e.splice(0,2),r=i(n,2),a=r[0],o=r[1];if("string"!=typeof a||!Number.isInteger(o)||!t.events.has(a))return t.emptyPromise();var s=[],u=!0,c=!1,l=void 0;try{for(var f,h=t.events.get(a).values()[Symbol.iterator]();!(u=(f=h.next()).done);u=!0){var v=f.value;s.push(t.promise(v,this,e,o))}}catch(p){c=!0,l=p}finally{try{!u&&h["return"]&&h["return"]()}finally{if(c)throw l}}return Promise.all(s)}}]),t}(),c=function(){function t(){n(this,t),this.components=new Map}return a(t,[{key:"newComponent",value:function(t){var e=this.components.get(t);if(null===e||void 0===e)return null;switch(typeof e){case"function":return new e;case"object":return function(t){var e={};return Object.keys(t).forEach(function(n){return e[n]=t[n]}),e}(e)}return e}},{key:"registerComponent",value:function(t){if(null===t||void 0===t)throw TypeError("component cannot be null.");var n=Math.max.apply(Math,e(this.components.keys())),r=void 0===n||null===n||n===-(1/0)?1:0===n?1:2*n;return this.components.set(r,t),r}},{key:"getComponents",value:function(){return this.components}}]),t}(),l={Get:0,GetWith:1,GetWithOnly:2,GetWithout:3},y=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?1e3:arguments[0];n(this,t),this.capacity=e,this.currentMaxEntity=-1,this.entityFactory=new f,this.systemManager=new s,this.componentManager=new c,this.eventHandler=new u,this.entities=Array.from({length:this.capacity},function(){return 0})}return a(t,[{key:"increaseCapacity",value:function(){var t=this.capacity;this.capacity*=2;for(var e=t;e<this.capacity;++e)this.entities[e]=0;var n=!0,r=!1,i=void 0;try{for(var a,o=this.componentManager.getComponents().keys()[Symbol.iterator]();!(n=(a=o.next()).done);n=!0)for(var s=a.value,e=t;e<this.capacity;++e)this[s].push(this.componentManager.newComponent(s))}catch(u){r=!0,i=u}finally{try{!n&&o["return"]&&o["return"]()}finally{if(r)throw i}}}},{key:"newEntity",value:function(t){if("number"!=typeof t||0>=t)return this.capacity;for(var e=0;e<this.capacity&&0!==this.entities[e];++e);return e>=this.capacity?this.capacity:(e>this.currentMaxEntity&&(this.currentMaxEntity=e),this.entities[e]=t,e)}},{key:"deleteEntity",value:function(t){if(this.entities[t]=0,!(t<this.currentMaxEntity))for(var e=t;e>=0;--e)if(0!==this.entities[e])return void(this.currentMaxEntity=e)}},{key:"getEntities",value:regeneratorRuntime.mark(function e(){var t,n=arguments.length<=0||void 0===arguments[0]?0:arguments[0],r=arguments.length<=1||void 0===arguments[1]?l.GetWith:arguments[1];return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next=e.t0===l.GetWith?3:e.t0===l.GetWithOnly?14:e.t0===l.GetWithout?25:e.t0===l.Get?36:46;break;case 3:e.t1=regeneratorRuntime.keys(this.entities);case 4:if((e.t2=e.t1()).done){e.next=13;break}if(t=e.t2.value,!(t>this.currentMaxEntity)){e.next=8;break}return e.abrupt("return");case 8:if(0===this.entities[t]||(this.entities[t]&n)!==n){e.next=11;break}return e.next=11,Math.floor(t);case 11:e.next=4;break;case 13:return e.abrupt("break",46);case 14:e.t3=regeneratorRuntime.keys(this.entities);case 15:if((e.t4=e.t3()).done){e.next=24;break}if(t=e.t4.value,!(t>this.currentMaxEntity)){e.next=19;break}return e.abrupt("return");case 19:if(0===this.entities[t]||this.entities[t]!==n){e.next=22;break}return e.next=22,Math.floor(t);case 22:e.next=15;break;case 24:return e.abrupt("break",46);case 25:e.t5=regeneratorRuntime.keys(this.entities);case 26:if((e.t6=e.t5()).done){e.next=35;break}if(t=e.t6.value,!(t>this.currentMaxEntity)){e.next=30;break}return e.abrupt("return");case 30:if(0===this.entities[t]||(this.entities[t]&n)===n){e.next=33;break}return e.next=33,Math.floor(t);case 33:e.next=26;break;case 35:return e.abrupt("break",46);case 36:e.t7=regeneratorRuntime.keys(this.entities);case 37:if((e.t8=e.t7()).done){e.next=45;break}if(t=e.t8.value,!(t>this.currentMaxEntity)){e.next=41;break}return e.abrupt("return");case 41:return e.next=43,Math.floor(t);case 43:e.next=37;break;case 45:return e.abrupt("break",46);case 46:case"end":return e.stop()}},e,this)})},{key:"registerComponent",value:function(t){var e=this.componentManager.registerComponent(t);this[e]=[];for(var n=0;n<this.capacity;++n)this[e].push(this.componentManager.newComponent(e));var r=void 0;switch(typeof t){case"function":r=t;break;case"object":r=function(){var e=!0,n=!1,r=void 0;try{for(var i,a=Object.keys(t)[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;this[o]=t[o]}}catch(s){n=!0,r=s}finally{try{!e&&a["return"]&&a["return"]()}finally{if(n)throw r}}};break;default:r=function(){return t}}return this.entityFactory.registerInitializer(e,r),e}},{key:"addComponent",value:function(t,e){this.entities[t]|=e}},{key:"removeComponent",value:function(t,e){this.entities[t]&=~e}},{key:"registerSystem",value:function(t,e,n,r){return this.systemManager.registerSystem(t,e,n,r)}},{key:"registerLogicSystem",value:function(t,e,n){return this.systemManager.registerSystem(o.Logic,t,e,n)}},{key:"registerRenderSystem",value:function(t,e,n){return this.systemManager.registerSystem(o.Render,t,e,n)}},{key:"removeSystem",value:function(t){return this.systemManager.removeSystem(t)}},{key:"onLogic",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=this.systemManager.logicSystems.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;o.callback.call(this,this.getEntities(o.components,o.selector),t)}}catch(s){n=!0,r=s}finally{try{!e&&a["return"]&&a["return"]()}finally{if(n)throw r}}}},{key:"onRender",value:function(t){var e=!0,n=!1,r=void 0;try{for(var i,a=this.systemManager.renderSystems.values()[Symbol.iterator]();!(e=(i=a.next()).done);e=!0){var o=i.value;o.callback.call(this,this.getEntities(o.components,o.selector),t)}}catch(s){n=!0,r=s}finally{try{!e&&a["return"]&&a["return"]()}finally{if(n)throw r}}}},{key:"registerInitializer",value:function(t,e){this.entityFactory.registerInitializer(t,e)}},{key:"build",value:function(){return this.entityFactory.build(),this}},{key:"withComponent",value:function(t,e){return this.entityFactory.withComponent(t,e),this}},{key:"createConfiguration",value:function(){return this.entityFactory.createConfiguration()}},{key:"create",value:function(t,e){return this.entityFactory.create(this,t,e)}},{key:"listen",value:function(t,e){return this.eventHandler.listen(t,e)}},{key:"stopListen",value:function(t){return this.eventHandler.stopListen(t)}},{key:"trigger",value:function(){var t;return(t=this.eventHandler.trigger).call.apply(t,[this].concat(r.call(arguments)))}},{key:"triggerDelayed",value:function(){var t;return(t=this.eventHandler.triggerDelayed).call.apply(t,[this].concat(r.call(arguments)))}}]),t}(),f=function(){function t(){n(this,t),this.initializers=new Map,this.configuration=new Map}return a(t,[{key:"registerInitializer",value:function(t,e){Number.isInteger(t)&&"function"==typeof e&&this.initializers.set(t,e)}},{key:"build",value:function(){return this.configuration=new Map,this}},{key:"withComponent",value:function(t,e){return Number.isInteger(t)?("function"!=typeof e&&(e=this.initializers.get(t)),this.configuration.set(t,e),this):this}},{key:"createConfiguration",value:function(){return this.configuration}},{key:"create",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?1:arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];if(!(t instanceof y))return[];n=n||this.configuration;var r=0,a=!0,o=!1,s=void 0;try{for(var u,c=n.keys()[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var l=u.value;r|=l}}catch(f){o=!0,s=f}finally{try{!a&&c["return"]&&c["return"]()}finally{if(o)throw s}}for(var h=[],v=0;e>v;++v){var p=t.newEntity(r);if(!(p>=t.capacity)){var m=!0,g=!1,d=void 0;try{for(var k,b=n[Symbol.iterator]();!(m=(k=b.next()).done);m=!0){var w=i(k.value,2),x=w[0],M=w[1];if("function"==typeof M){var S=M.call(t[x][p]);"function"!=typeof t[x][p]&&"object"!=typeof t[x][p]&&void 0!==S&&(t[x][p]=S)}}}catch(f){g=!0,d=f}finally{try{!m&&b["return"]&&b["return"]()}finally{if(g)throw d}}h.push(p)}}return 1===h.length?h[0]:h}}]),t}();t.EntityManager=y,t.SelectorType=l,t.SystemManager=s,t.SystemType=o,t.ComponentManager=c,t.EventHandler=u,t["default"]=y});